---
title: "p8105_hw6_lg3450"
output: github_document
---

first we load all necessary libraries:

```{r message=FALSE}
library(tidyverse)
library(modelr)
library(broom)
```

# Problem1

**The Washington Post has gathered data on homicides in 50 large U.S. cities and made the data available through a GitHub repository here. You can read their accompanying article here.**

* **Q1.1: Create a city_state variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. For this problem, limit your analysis those for whom victim_race is white or black. Be sure that victim_age is numeric.**

We first clean the dataset based on the requirements.

```{r warning=FALSE}
homicide_df = 
  read_csv("../homicide-data.csv") |>   
  mutate(
    # create city_state variable
    city_state = str_c(city, ", ", state),
    # add binary indicator
    resolved = as.numeric(disposition == "Closed by arrest"),
    # make victim_age numeric
    victim_age = as.numeric(victim_age)) |> 
  # omit 4 cities & limit analysis to White and Black
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black"))
```

* **Q1.2: For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors. Save the output of glm as an R object; apply the broom::tidy to this object; and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing male victims to female victims keeping all other variables fixed.**

```{r}
# fit the logistic regression model for Baltimore, MD
baltimore_glm = 
  homicide_df |> 
  filter(city_state == "Baltimore, MD") |> 
  glm(resolved ~ victim_age + victim_sex + victim_race, family = binomial(), data = _)

baltimore_glm |> 
  broom::tidy(conf.int = TRUE) |> 
  mutate(
    OR = exp(estimate), 
    OR_CI_lower = exp(conf.low),
    OR_CI_upper = exp(conf.high)) |> 
  filter(term == "victim_sexMale") |> 
  select(OR, OR_CI_lower, OR_CI_upper) |> 
  knitr::kable(
    digits = 3,
    col.names = c("estimated OR", "95% CI Lower", "95% CI Upper"),
    caption = "Table1: Estimate of Adjusted Odds Ratio for Male vs. Female Victims in Baltimore, MD", 
    align = "c")
```

The adjusted odds ratio for solving homicides comparing male victims to female victims in Baltimore is 0.426 (95% CI: 0.324, 0.558). This indicates that, holding victim age and race constant, homicides with male victims are significantly less likely to be resolved than those with female victims. Specifically, the odds of resolution for a male victim are approximately 43% of the odds for a female victim.

* **Q1.3: Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.**

```{r}
# run glm for each city using map
city_glm_results = 
  homicide_df |> 
  nest(data = -city_state) |> 
  mutate(
    # fit the logistic regression model for each city
    models = map(data, \(df) glm(resolved ~ victim_age + victim_sex + victim_race, 
                             family = binomial(), data = df)),
    
    # tidy the output of each model and get CIs
    tidy_results = map(models, \(mod) broom::tidy(mod, conf.int = TRUE))) |> 
  select(-models, -data) |> 
  unnest(cols = tidy_results) |> 
  mutate(
    # convert log-odds to Odds Ratios
    OR = exp(estimate), 
    OR_CI_upper = exp(conf.high),
    OR_CI_lower = exp(conf.low)) |> 
  # filter for the term of interest (Male vs Female)
  filter(term == "victim_sexMale") |> 
  select(city_state, OR, OR_CI_lower, OR_CI_upper) |> 
  # sort by Odds Ratio (lowest to highest)
  arrange(OR)

# display the table
city_glm_results |> 
  slice(1:10) |>
  knitr::kable(
    digits = 3,
    col.names = c("City", "estimated OR", "95% CI Lower", "95% CI Upper"),
    caption = "Table 2: Odds Ratios for Solving Homicides (Male vs. Female Victims) by City",
    align = "c")
```

* **Q1.4: Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.**

```{r}
# create plot showing the ORs and CIs for each city
city_glm_results |> 
  mutate(city_state = fct_reorder(city_state, OR)) |> 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = OR_CI_lower, ymax = OR_CI_upper)) + 
  geom_hline(yintercept = 1, linetype = "dashed", color = "orange") +
  coord_flip() +
  labs(
    title = "Odds Ratios for Solving Homicides (Male vs. Female Victims)",
    x = "City",
    y = "Odds Ratio (Male vs. Female)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

The plot illustrates that for the vast majority of cities, the estimated odds ratio (OR) is less than 1, indicating that homicides with male victims are less likely to be resolved than those with female victims, after adjusting for victim age and race.

New York, NY has the lowest Odds Ratio, suggesting the largest disparity where male cases are significantly less likely to be solved.

For cities where the 95% confidence intervals do not contain the null value of 1 (the orange dashed line) (such as Baltimore, Chicago, and Philadelphia), the difference in resolution rates between genders is statistically significant.

A few cities (such as Albuquerque, Stockton, and Fresno) have 95% confidence interval that cross the line of 1. For these locations, we cannot conclude there is a statistically significant difference in homicide resolution rates between genders.

# Problem2
first we import the Central Park weather data:
```{r}
library(p8105.datasets)
data("weather_df")
```

Use 5000 bootstrap samples and, for each bootstrap sample, produce estimates of these two quantities. 



Plot the distribution of your estimates, and describe these in words. 

Using the 5000 bootstrap estimates, identify the 2.5% and 97.5% quantiles to provide a 95% confidence interval for xx xx








# Problem3















